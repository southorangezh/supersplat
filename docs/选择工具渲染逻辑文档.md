# SuperSplat 选择工具渲染逻辑文档

本文档详细说明了 playcanvas/supersplat 项目中选择工具的具体渲染逻辑。

## 目录

- [2D 选择工具渲染逻辑](#2d-选择工具渲染逻辑)
- [3D 选择工具渲染逻辑](#3d-选择工具渲染逻辑)
- [变换工具渲染逻辑](#变换工具渲染逻辑)
- [测量工具渲染逻辑](#测量工具渲染逻辑)
- [轮廓渲染](#轮廓渲染)

---

## 2D 选择工具渲染逻辑

2D 选择工具（矩形选择、画刷选择、套索选择、多边形选择）使用共享的 `maskCanvas` 系统进行像素级选择操作。

### maskCanvas 初始化

- `maskCanvas` 是一个 HTMLCanvasElement，在 `src/main.ts` 中创建
- 它被设置为 `id = 'mask-canvas'`
- 其 2D 上下文的 `globalCompositeOperation` 设置为 `'copy'`，这意味着绘制操作会替换像素而不是混合像素
- `maskCanvas` 被添加到 `editorUI.toolsContainer.dom` 中

### 工具激活

当一个 2D 选择工具被激活时：
- 它会使其父元素可见
- 注册 `pointerdown`、`pointermove` 和 `pointerup` 等事件监听器

### 绘制到 maskCanvas

#### RectSelection（矩形选择）

- 在 `pointerdown` 事件中，它会捕获指针，记录起始点
- 在 `pointermove` 事件中更新矩形的结束点
- 调用 `updateRect()` 来更新 SVG 矩形元素的属性，使其在 UI 上可见

#### BrushSelection（画刷选择）

- 在 `pointerdown` 事件中，它会初始化 `maskCanvas` 的尺寸并清除其内容
- 在 `pointermove` 事件中，它会在 `maskCanvas` 上绘制一个圆形笔触，形成连续的线条
- 画刷的大小可以通过 `[` 和 `]` 键进行调整

#### LassoSelection（套索选择）

- 在 `pointermove` 事件中，它会根据鼠标移动轨迹记录一系列点
- 更新 SVG 多边形元素以显示套索的形状

#### PolygonSelection（多边形选择）

- 在 `pointermove` 事件中，它会更新当前点并绘制 SVG 折线以显示多边形的边缘
- 在 `pointerup` 事件中，它会添加新的点，直到双击或闭合多边形

### 提交选择

当选择操作完成（例如，`pointerup` 事件）时：
- 工具会根据 `maskCanvas` 的内容触发 `select.byMask` 事件
- `select.byMask` 事件会传递 `maskCanvas` 和其 2D 上下文，以及选择操作类型（'add'、'remove' 或 'set'）
- `src/editor.ts` 中的事件监听器会处理这些选择事件，并根据 `maskCanvas` 的像素信息来确定哪些 splat 被选中

---

## 3D 选择工具渲染逻辑

3D 选择工具，如 `SphereSelection`（球体选择）和 `BoxSelection`（盒子选择），使用 3D 几何体进行空间选择。

### 工具注册

- `SphereSelection` 和 `BoxSelection` 工具在 `src/main.ts` 中被注册到 `ToolManager` 中
- 它们接收 `Events` 和 `Scene` 实例

### 选择事件

- 当这些工具被使用时，它们会触发 `select.bySphere` 或 `select.byBox` 事件
- 传递 3D 几何体的参数

### 渲染

- 这些工具的渲染通常涉及在场景中显示一个 3D 几何体（球体或盒子）来表示选择区域
- 具体的渲染实现可能在各自的工具文件中，但核心逻辑是利用 PlayCanvas 的 3D 渲染能力

---

## 变换工具渲染逻辑

变换工具，如 `MoveTool`（移动工具）、`RotateTool`（旋转工具）和 `ScaleTool`（缩放工具），与 PlayCanvas 的 `TransformGizmo` 集成。

### TransformGizmo

- `TransformTool` 类封装了 `TransformGizmo` 的行为

### 激活与附着

- 当变换工具被激活时，它会创建一个 `pivotEntity` 并将其附着到 `TransformGizmo` 上

### 渲染更新

- `TransformGizmo` 会在其渲染更新时强制场景重新渲染（`scene.forceRender = true`），以确保 gizmo 的可见性

### 尺寸调整

- gizmo 的尺寸会根据摄像机的正交模式和画布尺寸进行调整
- 以保持在屏幕空间中的恒定大小

---

## 测量工具渲染逻辑

`MeasureTool`（测量工具）用于测量 3D 空间中的距离。

- 它的渲染逻辑涉及在场景中绘制线条或标记来表示测量结果

---

## 轮廓渲染

当 splat 被选中时，`Outline` 类负责渲染其轮廓。

### 相机设置

- `Outline` 创建一个带有相机组件的实体
- 将其 `shaderPass` 设置为 `'OUTLINE'`

### 图层管理

- 当选择发生变化时，选中的 splat 会被添加到 `overlayLayer` 中

### 后渲染

- 在 `postRenderLayer` 事件中，`Outline` 会使用一个自定义着色器（`outline-shader`）来渲染轮廓
- 它会设置混合状态、剔除模式和深度状态
- 传递轮廓纹理、alpha 截止值和颜色

---

## 相关文件

- `src/main.ts` - 工具注册和 maskCanvas 初始化
- `src/editor.ts` - 选择事件处理
- `src/ui/bottom-toolbar.ts` - 工具栏按钮和工具激活
- `src/tools/` - 各种工具的实现
  - `rect-selection.ts` - 矩形选择工具
  - `brush-selection.ts` - 画刷选择工具
  - `lasso-selection.ts` - 套索选择工具
  - `polygon-selection.ts` - 多边形选择工具
  - `sphere-selection.ts` - 球体选择工具
  - `box-selection.ts` - 盒子选择工具
  - `move-tool.ts` - 移动工具
  - `rotate-tool.ts` - 旋转工具
  - `scale-tool.ts` - 缩放工具
  - `measure-tool.ts` - 测量工具
  - `transform-tool.ts` - 变换工具基类
  - `tool-manager.ts` - 工具管理器
- `src/outline.ts` - 轮廓渲染实现

---

## 参考资料

- [Camera System (playcanvas/supersplat)](https://deepwiki.com/wiki/playcanvas/supersplat#8.1)
- [Editing Tools (playcanvas/supersplat)](https://deepwiki.com/wiki/playcanvas/supersplat#9)

---

*文档生成时间：2024年*
*来源：playcanvas/supersplat 仓库文档查询*

